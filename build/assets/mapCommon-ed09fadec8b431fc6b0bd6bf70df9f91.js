//# sourceMappingURL=mapCommon.js.map
(function(a){"function"===typeof define&&define.amd?define(a):window.purl=a()})(function(){function a(c,a){c=decodeURI(c);a=t[a?"strict":"loose"].exec(c);c={attr:{},param:{},seg:{}};for(var b=14;b--;)c.attr[u[b]]=a[b]||"";c.param.query=q(c.attr.query);c.param.fragment=q(c.attr.fragment);c.seg.path=c.attr.path.replace(/^\/+|\/+$/g,"").split("/");c.seg.fragment=c.attr.fragment.replace(/^\/+|\/+$/g,"").split("/");c.attr.base=c.attr.host?(c.attr.protocol?c.attr.protocol+"://"+c.attr.host:c.attr.host)+
(c.attr.port?":"+c.attr.port:""):"";return c}function d(a){a=a.tagName;return"undefined"!==typeof a?v[a.toLowerCase()]:a}function h(a,f,b,d){var g=a.shift();if(g){var e=f[b]=f[b]||[];if("]"==g)if(n(e))""!==d&&e.push(d);else if("object"==typeof e){f=a=e;b=[];for(var k in f)f.hasOwnProperty(k)&&b.push(k);a[b.length]=d}else f[b]=[f[b],d];else{~g.indexOf("]")&&(g=g.substr(0,g.length-1));if(!r.test(g)&&n(e))if(0===f[b].length)e=f[b]={};else{k={};for(var m in f[b])k[m]=f[b][m];e=f[b]=k}h(a,e,g,d)}}else n(f[b])?
f[b].push(d):f[b]="object"==typeof f[b]?d:"undefined"==typeof f[b]?d:[f[b],d]}function q(a){return w(String(a).split(/&|;/),function(a,b){try{b=decodeURIComponent(b.replace(/\+/g," "))}catch(d){}var c=b.indexOf("="),g;a:{for(var e=b.length,k,m=0;m<e;++m)if(k=b[m],"]"==k&&(g=!1),"["==k&&(g=!0),"="==k&&!g){g=m;break a}g=void 0}e=b.substr(0,g||c);c=b.substr(g||c,b.length);c=c.substr(c.indexOf("=")+1,c.length);""===e&&(e=b,c="");b=e;if(~b.indexOf("]")){var l=b.split("[");h(l,a,"base",c)}else{if(!r.test(b)&&
n(a.base)){e={};for(l in a.base)e[l]=a.base[l];a.base=e}""!==b&&(l=a.base,e=l[b],"undefined"===typeof e?l[b]=c:n(e)?e.push(c):l[b]=[e,c])}return a},{base:{}}).base}function w(a,d,b){for(var h=0,g=a.length>>0;h<g;)h in a&&(b=d.call(void 0,b,a[h],h,a)),++h;return b}function n(a){return"[object Array]"===Object.prototype.toString.call(a)}function p(c,d){1===arguments.length&&!0===c&&(d=!0,c=void 0);c=c||window.location.toString();return{data:a(c,d||!1),attr:function(a){a=x[a]||a;return"undefined"!==
typeof a?this.data.attr[a]:this.data.attr},param:function(a){return"undefined"!==typeof a?this.data.param.query[a]:this.data.param.query},fparam:function(a){return"undefined"!==typeof a?this.data.param.fragment[a]:this.data.param.fragment},segment:function(a){if("undefined"===typeof a)return this.data.seg.path;a=0>a?this.data.seg.path.length+a:a-1;return this.data.seg.path[a]},fsegment:function(a){if("undefined"===typeof a)return this.data.seg.fragment;a=0>a?this.data.seg.fragment.length+a:a-1;return this.data.seg.fragment[a]}}}
var v={a:"href",img:"src",form:"action",base:"href",script:"src",iframe:"src",link:"href",embed:"src",object:"data"},u="source protocol authority userInfo user password host port relative path directory file query fragment".split(" "),x={anchor:"fragment"},t={strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/},
r=/^[0-9]+$/;p.jQuery=function(a){null!=a&&(a.fn.url=function(f){var b="";this.length&&(b=a(this).attr(d(this[0]))||"");return p(b,f)},a.url=p)};p.jQuery(window.jQuery);return p});var areaCounter=0;function addClickEventForVector(a){var d="drawnArea"+areaCounter;areaCounter++;MAP_VAR.map.addHandler(d,L.AreaPopupHandler.extend({layer:a}));MAP_VAR.map[d].enable()}function removeLayer(a){void 0!==MAP_VAR.map._layers[a]&&MAP_VAR.map.removeLayer(MAP_VAR.map._layers[a])}
L.AreaPopupHandler=L.Handler.extend({layer:null,addHooks:function(){L.DomEvent.on(this.layer,"click",this._generatePopup,this)},removeHooks:function(){L.DomEvent.off(this.layer,"click",this._generatePopup,this)},_generatePopup:function(a){generatePopup(this.layer,a.latlng)}});L.PointClickHandler=L.Handler.extend({obj:null,addHooks:function(){L.DomEvent.on(this.obj,"click",pointLookupClickRegister,this)},removeHooks:function(){L.DomEvent.off(this.obj,"click",pointLookupClickRegister,this)}});
function generatePopup(a,d){var h;jQuery.isFunction(a.getRadius)?h=getParamsForCircle(a):(h=new Wkt.Wkt,h.fromObject(a),h=getParamsforWKT(h.write()));null==d&&(d=a.getBounds().getCenter());L.popup().setLatLng([d.lat,d.lng]).setContent("species count: <b id='speciesCountDiv'>calculating...</b><br>occurrence count: <b id='occurrenceCountDiv'>calculating...</b><br><a id='showOnlyTheseRecords' href='"+BC_CONF.contextPath+"/occurrences/search"+h+"'>"+jQuery.i18n.prop("search.map.popup.linkText")+"</a><br><a id='removeArea' href='javascript:void(0)' onclick='removeLayer(\""+
a._leaflet_id+"\");MAP_VAR.map.closePopup()'>"+jQuery.i18n.prop("search.map.popup.removeText")+"</a>").openOn(MAP_VAR.map);getSpeciesCountInArea(h);getOccurrenceCountInArea(h)}function getSpeciesCountInArea(a){speciesCount=-1;$.getJSON(BC_CONF.biocacheServiceUrl+"/occurrence/facets.json"+a+"&facets=taxon_name&callback=?",function(a){a&&0<a.length&&void 0!==a[0].count?(a=a[0].count,document.getElementById("speciesCountDiv").innerHTML=a):document.getElementById("speciesCountDiv").innerHTML=0})}
function getOccurrenceCountInArea(a){occurrenceCount=-1;$.getJSON(BC_CONF.biocacheServiceUrl+"/occurrences/search.json"+a+"&pageSize=0&facet=off&callback=?",function(a){a&&void 0!==a.totalRecords?(a=a.totalRecords,document.getElementById("occurrenceCountDiv").innerHTML=a,"0"==a&&$("#showOnlyTheseRecords").hide()):document.getElementById("occurrenceCountDiv").innerHTML=0})}function getParamsforWKT(a){return"?"+getExistingParams()+"&wkt="+encodeURI(a.replace(" ","+"))}
function getParamsForCircle(a){var d=a.getLatLng();a=Math.round(a.getRadius()/1E3*10)/10;return"?"+getExistingParams()+"&radius="+a+"&lat="+d.lat+"&lon="+d.lng}function getExistingParams(){var a=$.url(MAP_VAR.query).param();a.q||(a.q="*:*");delete a.wkt;delete a.lat;delete a.lon;delete a.radius;var d=document.createElement("textarea");d.innerHTML=decodeURI(BC_CONF.queryContext);a.qc=d.value;return $.param(a)}
function drawWktObj(a){var d=new Wkt.Wkt;d.read(a);a=d.toObject({color:"#bada55"});generatePopup(a.getLayers()[0],null);addClickEventForVector(a);MAP_VAR.drawnItems.addLayer(a);void 0!==a.getBounds&&"function"===typeof a.getBounds?MAP_VAR.map.fitBounds(a.getBounds()):focus&&void 0!==a.getLatLng&&"function"===typeof a.getLatLng&&MAP_VAR.map.panTo(a.getLatLng())};