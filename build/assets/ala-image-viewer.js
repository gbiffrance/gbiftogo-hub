//# sourceMappingURL=ala-image-viewer.js.map
Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(d,u){if(null==this)throw new TypeError('"this" is null or not defined');var v=Object(this),C=v.length>>>0;if("function"!==typeof d)throw new TypeError("predicate must be a function");for(var h=0;h<C;){var z=v[h];if(d.call(u,z,h,v))return z;h++}}});var imgvwr={};
(function(d){function u(a,b,c){b={target:b,imageId:c};$.extend(b,F,a);return b}function v(a,b,c,d){var e=$.Deferred(),k=d+"/ws/species?guid="+a+"&dr="+c;$.ajax({dataType:"json",url:k,type:"get",timeout:8E3,success:function(a){a?(a=a.find(function(a){return a.kvpValues.find(function(a){return"imageId"==a.key&&a.value==b})}),e.resolve(void 0!=a)):e.resolve(!1)},error:function(a,b,c){console.error("Error when calling "+k+" ("+c+")");e.reject(a,b,c);return e}});return e}function C(a,b,c){var d=$.Deferred();
$.ajax({dataType:"json",url:c,type:"get",timeout:8E3,success:function(c){c?(c=c.find(function(c){return c.name===a&&c.imageId===b}),d.resolve(void 0!=c)):d.resolve(!1)},error:function(a,b,l){console.error("Error when calling "+c+"("+l+")");d.reject(a,b,l);return d}});return d}function h(a){$.ajax({dataType:"jsonp",url:f+"/ws/getImageInfo/"+n,crossDomain:!0}).done(function(b){b.success?z(a,b):alert("Unable to load image from "+f+"/ws/getImageInfo/"+n)}).fail(function(){alert("Unable to load image from "+
f+"/ws/getImageInfo/"+n)})}function z(a,b){n=a.imageId;var c=b.tileZoomLevels?b.tileZoomLevels-1:0;m=Math.pow(2,c);D=b.height;var p=b.width/2/m,e=b.height/2/m,k=L.latLng(b.height/m,0),l=L.latLng(0,b.width/m),k=new L.latLngBounds(k,l),l=!1,h=new L.FeatureGroup;x=new L.FeatureGroup;a.addCalibration&&(l={mmPerPixel:b.mmPerPixel,imageScaleFactor:m,imageWidth:b.width,imageHeight:b.height,hideCalibration:!a.addCalibration,onCalibration:function(a){d.showModal({url:A+"/imageClient/calibrateImage?id="+n+
"&pixelLength="+Math.round(a),title:"Calibrate image scale"})}});var w=$(a.target).get(0);y[w]&&(y[w].remove(),delete y[w]);var g=L.map(w,{fullscreenControl:!0,measureControl:l,minZoom:2,maxZoom:c,zoom:getInitialZoomLevel(a.initialZoom,c,b,a.target),center:new L.LatLng(e,p),crs:L.CRS.Simple});q=g;g.addLayer(h);y[w]=g;L.tileLayer(b.tileUrlPattern,{maxNativeZoom:c,continuousWorld:!0,tms:!0,noWrap:!0,bounds:k,attribution:"Atlas of Living Australia"}).addTo(g);a.addImageInfo&&(c=L.Control.extend({options:{position:"bottomleft",
title:"Image details"},onAdd:function(a){a=L.DomUtil.create("div","leaflet-bar");var b=f+"/image/details/"+n;$(a).html("<a href='"+b+"' title='"+this.options.title+"'><span class='fa fa-external-link'></span></a>");return a}}),g.addControl(new c));a.auxDataUrl&&(c=L.Control.extend({options:{position:"topleft",title:"Auxiliary data"},onAdd:function(b){b=L.DomUtil.create("div","leaflet-bar");$(b).html("<a id='btnImageAuxInfo'  title='"+a.auxDataTitle+"' href='#'><span class='fa fa-info'></span></a>");
$(b).find("#btnImageAuxInfo").click(function(b){b.preventDefault();$.ajax({dataType:"jsonp",url:a.auxDataUrl,crossDomain:!0}).done(function(a){var b="";if(a.data){var b='<table class="table table-condensed table-striped table-bordered">',c;for(c in a.data)b+="<tr><td>"+c+"</td><td>"+a.data[c]+"</td></tr>";b+="</table>"}a.link&&a.linkText?b+='<div><a class="btn btn-primary" href="'+a.link+'">'+a.linkText+"</a>":a.link&&(b+='<div><a class="btn btn-primary" href="'+a.link+'">'+a.link+"</a>");d.showModal({title:a.title?
a.title:"Image "+n,content:b,width:800})})});return b}}),g.addControl(new c));a.addDownloadButton&&(c=L.Control.extend({options:{position:"topleft",title:"Download button"},onAdd:function(a){a=L.DomUtil.create("div","leaflet-bar");$(a).html("<a id='btnDownload' title='Download this image' href='#'><span class='fa fa-download'></span></a>");$(a).find("#btnDownload").click(function(a){a.preventDefault();window.location.href=f+"/image/proxyImage/"+n+"?contentDisposition=true"});return a}}),g.addControl(new c));
a.addDrawer&&(c=new L.Control.Draw({edit:{featureGroup:h},draw:{position:"topleft",circle:!1,rectangle:{shapeOptions:{weight:1,color:"blue"}},marker:!1,polyline:!1,polygon:!1}}),g.addControl(c),$(".leaflet-draw-toolbar").last().append('<a id="btnCreateSubimage" class="viewer-custom-buttons leaflet-disabled fa fa-picture-o" href="#" title="Draw a rectangle to create a sub image"></a>'),$("#btnCreateSubimage").click(function(a){a.preventDefault();a=h.getLayers();if(!(0>=a.length)){a=a[0].getLatLngs();
for(var c=b.width,e=b.height,p=0,g=0,l=0;l<a.length;++l){var k=Math.round(b.height-a[l].lat*m),f=Math.round(a[l].lng*m);k<e&&(e=k);k>g&&(g=k);f<c&&(c=f);f>p&&(p=f)}d.showModal({title:"Create subimage",url:A+"/imageClient/createSubImage?id="+n+"&x="+c+"&y="+e+"&width="+(p-c)+"&height="+(g-e),onClose:function(){h.clearLayers()}})}}),g.on("draw:created",function(a){a=a.layer;h.clearLayers();h.addLayer(a);$("#btnCreateSubimage").removeClass("leaflet-disabled");$("#btnCreateSubimage").attr("title","Create a subimage from the currently drawn rectangle")}),
g.on("draw:deleted",function(a){a=$("#btnCreateSubimage");a.addClass("leaflet-disabled");a.attr("title","Draw a rectangle to create a subimage")}));a.addSubImageToggle&&(g.addLayer(x),c=L.Control.extend({options:{position:"topright",title:"View subimages button"},onAdd:function(a){a=L.DomUtil.create("div","leaflet-bar");$(a).html("<a id='btnViewSubimages' data-switch='off' title='View subimages' href='#' style='width:110px;'>Show&nbsp;subimages</a>");$(a).find("#btnViewSubimages").click(function(a){a.preventDefault();
d.toggleSubimages()});return a}}),g.addControl(new c));a.addPreferenceButton&&(c=L.Control.extend({options:{position:"topleft",title:"Add image to ALA Preferred Species Images List",preferredImageStatus:E,savePreferredSpeciesListUrl:a.savePreferredSpeciesListUrl},onAdd:function(a){var b=this,c=L.DomUtil.create("div","leaflet-bar");$(c).html("<a id='btnPreferredImage' title='Add image to Preferred Species Images List' href='#'><span class='fa fa-star'></span></a>");$(c).find("#btnPreferredImage").click(function(a){a.preventDefault();
b.options.preferredImageStatus?B("You cannot add this images as it has already been added to ALA Preferred Species Image List"):$.ajax({url:b.options.savePreferredSpeciesListUrl,success:function(a){200==a.status?(G(c),1==b.options.preferredImageStatus,B("This Image has been successfully added to ALA Preferred Species Image List")):B("An error has occurred: Status "+a.status+" Reason: "+a.text)},error:function(a){B("An error occurred while saving metadata to image. Status: "+a.status+" Reason: "+a.responseText)}})});
b.options.preferredImageStatus&&G(c);return c}}),g.addControl(new c));if(a.addLikeDislikeButton){var r,c=L.Control.extend({options:{position:"topleft",title:"Close this dialog",disableButtons:a.disableLikeDislikeButton,likeUrl:a.likeUrl,dislikeUrl:a.dislikeUrl,userRatingUrl:a.userRatingUrl},onAdd:function(b){var c=this;b=L.DomUtil.create("div","leaflet-bar leaflet-control");$(b).html('<a id="leafletLikeButton" href="#" class="fa fa-thumbs-o-up fa-2" aria-hidden="true"></i><a id="leafletDislikeButton" href="#" class="fa fa-thumbs-o-down fa-2" aria-hidden="true"></a><a id="leafletLikeDislikeHelpButton" href="#" class="fa fa-question fa-2" aria-hidden="true" title="Show help text"></a>');
$(b).find("#leafletLikeButton").on("click",function(a){a.preventDefault();c.options.disableButtons||(t.addLoader("like"),$.ajax({url:c.options.likeUrl,success:function(a){a.content.success&&(H(),t.removeLoader("like"))},error:function(){t.removeLoader("like")}}))});$(b).find("#leafletDislikeButton").on("click",function(a){a.preventDefault();c.options.disableButtons||(t.addLoader("dislike"),$.ajax({url:c.options.dislikeUrl,success:function(a){a.content.success&&(I(),t.removeLoader("dislike"))},error:function(){t.removeLoader("dislike")}}))});
$(b).find("#leafletLikeDislikeHelpButton").on("click",function(b){r&&(g.removeControl(r),r=null);r=new (L.Control.extend({options:{position:"topleft",userRatingHelpText:a.userRatingHelpText},onAdd:function(a){this.container=a=L.DomUtil.create("div","leaflet-control-layers");var b=this.options.userRatingHelpText||F.userRatingHelpText;$(a).html('<div style="padding:10px; width: 200px;"><a href="#" class="user-rating-help-text-dialog pull-right" style="padding-left:10px;"><b style="color:black"><i class="fa fa-times"></i></b></a>'+
b+"</div>");$(a).find(".user-rating-help-text-dialog").on("click",function(a){g.removeControl(r);r=null;a.preventDefault()});return a}}));g.addControl(r);b.preventDefault()});this.options.disableButtons?($(b).find("#leafletLikeButton").addClass("leaflet-disabled").attr("title","You must be logged in"),$(b).find("#leafletDislikeButton").addClass("leaflet-disabled").attr("title","You must be logged in"),$(b).attr("title","You must be logged in")):this.options.userRatingUrl&&$.ajax({url:this.options.userRatingUrl,
success:function(a){switch(a.success){case "LIKE":H();break;case "DISLIKE":I()}}});return b}});g.addControl(new c)}if(a.addLoading){var t=L.Control.loading({separate:!0});g.addControl(t)}a.addCloseButton&&(c=L.Control.extend({options:{position:"topright",title:"Close this dialog"},onAdd:function(a){a=L.DomUtil.create("div","leaflet-bar");var b=$(a);b.html('<a id="closeLeafletModalButton" href="#" class="">&times;</a>');b.attr("title","Close this dialog");b.find("#closeLeafletModalButton").click(function(a){a.preventDefault();
$(this).parents(".modal").modal("hide")});return a}}),g.addControl(new c));a.addAttribution&&(c=L.Control.extend({options:{position:"bottomright",title:"Show attribution",attribution:a.attribution},onAdd:function(a){this.container=a=L.DomUtil.create("div","leaflet-control-layers");$(a).html("<div style='padding:10px'>"+this.options.attribution+"</div>");return a}}),g.addControl(new c));a.galleryOptions.enableGalleryMode&&(a.galleryOptions.closeControlContent&&(c=L.Control.extend({options:{position:"topright",
title:"Close gallery",content:a.galleryOptions.closeControlContent},onAdd:function(a){a=this.options;var b=window.fullScreenApi.isFullScreen()?"hidden":"",b=L.DomUtil.create("div","leaflet-control-close-popup leaflet-bar leaflet-control "+b),c=L.DomUtil.create("a","",b);c.innerHTML=a.content;c.href="#";b.title=a.title;L.DomEvent.on(b,"click",function(){$(".leaflet-control-close-popup i").click()});return b}}),g.addControl(new c)),a.galleryOptions.showFullScreenControls&&(c=L.Control.extend({options:{position:"topright"},
onAdd:function(){var a=window.fullScreenApi.isFullScreen()?"":"hidden",a=L.DomUtil.create("div","leaflet-gallery-control-bar leaflet-bar leaflet-control leaflet-bar-horizontal "+a,this._control),b=L.DomUtil.create("a","leaflet-control-previous",a);b.innerHTML='<i class="fa fa-arrow-left" style="line-height:1.65;"></i>';b.title="Got to previous image";b=L.DomUtil.create("a","leaflet-control-next",a);b.innerHTML='<i class="fa fa-arrow-right" style="line-height:1.65;"></i>';b.title="Got to next image";
return a}}),g.addControl(new c)),$(document).off(window.fullScreenApi.fullScreenEventName),$(document).on(window.fullScreenApi.fullScreenEventName,function(a){window.fullScreenApi.isFullScreen()?($(".leaflet-control-close-popup").addClass("hidden"),$(".leaflet-gallery-control-bar").removeClass("hidden")):($(".leaflet-control-close-popup").removeClass("hidden"),$(".leaflet-gallery-control-bar").addClass("hidden"))}),$(document).off("click","a.leaflet-control-previous"),$(document).on("click","a.leaflet-control-previous",
function(){var a=jQuery.Event("keydown");a.which=37;$(document).trigger(a)}),$(document).off("click","a.leaflet-control-next"),$(document).on("click","a.leaflet-control-next",function(){var a=jQuery.Event("keydown");a.which=39;$(document).trigger(a)}))}function B(a){$("#alertModal").length&&$("#alertContent").length?($("#alertContent").text(a),$("#alertModal").modal("show")):bootbox.alert(a)}function G(a){$(a).find("#btnPreferredImage").css("color","orange").attr("title","You have added this image to ALA Preferred Image Species List")}
function H(){$("#leafletLikeButton").removeClass("fa-thumbs-o-up").addClass("fa-thumbs-up").css("color","green").attr("title","You up voted this image");$("#leafletDislikeButton").addClass("fa-thumbs-o-down").removeClass("fa-thumbs-down").css("color","black").attr("title","Click to down vote this image")}function I(){$("#leafletLikeButton").removeClass("fa-thumbs-up").addClass("fa-thumbs-o-up").css("color","black").attr("title","Click to up vote this image");$("#leafletDislikeButton").addClass("fa-thumbs-down").removeClass("fa-thumbs-o-down").css("color",
"red").attr("title","You down voted this image!")}var q,x,n,E,m,D,y={},f="https://images.ala.org.au",A="",F={auxDataUrl:"",auxDataTitle:"View more information about this image",attribution:null,initialZoom:"auto",disableLikeDislikeButton:!1,addDownloadButton:!0,addDrawer:!0,addSubImageToggle:!0,addCalibration:!0,addCloseButton:!1,addImageInfo:!0,addLoading:!0,addAttribution:!1,addPreferenceButton:!1,addLikeDislikeButton:!1,dislikeUrl:"",likeUrl:"",userRatingUrl:"",userRatingHelpText:'<div><b>Up vote (<i class="fa fa-thumbs-o-up" aria-hidden="true"></i>) an image:</b> Image supports the identification of the species or is representative of the species.\u2002\u2002Subject is clearly visible including identifying features.<br/><br/><b>Down vote (<i class="fa fa-thumbs-o-down" aria-hidden="true"></i>) an image:</b> Image does not support the identification of the species, subject is unclear and identifying features are difficult to see or not visible.<br/></div>',
savePreferredSpeciesListUrl:"",getPreferredSpeciesListUrl:"",druid:"",galleryOptions:{enableGalleryMode:!1,closeControlContent:null,showFullScreenControls:!1}};d.getImageClientBaseUrl=function(){return A};d.getImageServiceBaseUrl=function(){return f};d.setImageClientBaseUrl=function(a){A=a};d.setImageServiceBaseUrl=function(a){f=a};d.setPixelLength=function(a){q.measureControl.mmPerPixel=a};d.viewImage=function(a,b,c,p,e){n=b;E=!1;e.imageServiceBaseUrl&&d.setImageServiceBaseUrl(e.imageServiceBaseUrl);
e.imageClientBaseUrl&&d.setImageClientBaseUrl(e.imageClientBaseUrl);if(e.addPreferenceButton){var k=null;void 0!=p?k=v(p,b,e.druid,e.getPreferredSpeciesListUrl):void 0!=c&&(k=C(c,b,e.getPreferredSpeciesListUrl));$.when(k).then(function(c){void 0!=c&&(E=c);c=u(e,a,b);h(c)},function(c){e.addPreferenceButton=!1;c=u(e,a,b);h(c)})}else c=u(e,a,b),h(c)};d.resizeViewer=function(a){a=$(a).get(0);y[a].invalidateSize()};d.removeCurrentImage=function(){q&&q.eachLayer(function(a){q.removeLayer(a)})};d.getViewerInstance=
function(){return q};d.showSubimages=function(){x.clearLayers();$.ajax(f+"/ws/getSubimageRectangles/"+n).done(function(a){if(a.success){for(var b in a.subimages){var c=a.subimages[b],d=c.imageId,c=L.rectangle([[(D-c.y)/m,c.x/m],[(D-(c.y+c.height))/m,(c.x+c.width)/m]],{color:"#ff7800",weight:1,imageId:d,className:d});c.addTo(x);c.on("click",function(a){if(a=a.target.options.imageId)window.location=f+"/image/details?imageId="+a});c.on("mouseover",function(a){var b=L.popup().setLatLng(a.latlng).setContent("<p>Loading.."+
a.target.options.imageId+".</p>").openOn(q);$.ajax(f+"/image/imageTooltipFragment?imageId="+a.target.options.imageId).then(function(a){b.setContent(a)},function(a,b,c){console.log(b+": "+c)})});c.on("mouseout",function(a){this.closePopup()})}$(".subimage-path").each(function(){var a=$(this).attr("class"),a=$.trim(a).split(" ");for(index in a)if(a[index].match(/imageId[-](.*)/))break})}$("#btnViewSubimages").html("Hide&nbsp;subimages");$.data($("#btnViewSubimages"),"switch","on")})};d.hideSubimages=
function(){x.clearLayers()};d.toggleSubimages=function(){"off"==$(this).data("switch")||void 0===$(this).data("switch")?(d.showSubimages(),$("#btnViewSubimages").html("Hide&nbsp;subimages"),$.data(this,"switch","on")):(d.hideSubimages(),$("#btnViewSubimages").html("Show&nbsp;subimages"),$.data(this,"switch","off"))};getInitialZoomLevel=function(a,b,c,d){var e=b;if("auto"==a)if(a=$(d).width(),d=$(d).height(),b=c.width,c=c.height,b>c)for(;a<b&&0<e;)e--,b/=2;else for(;d<c&&0<e;)e--,c/=2;else $.isNumeric(a)&&
Math.abs(a)<=b&&(e=Math.abs(a));return e};d.showModal=function(a){var b={backdrop:a.backdrop?a.backdrop:!0,keyboard:a.keyboard?a.keyboard:!0,url:a.url?a.url:!1,id:a.id?a.id:"modal_element_id",height:a.height?a.height:500,width:a.width?a.width:600,title:a.title?a.title:"Modal Title",hideHeader:a.hideHeader?a.hideHeader:!1,onClose:a.onClose?a.onClose:null,onShown:a.onShown?a.onShown:null,content:a.content};a="<div id='"+b.id+"' class='modal hide' role='dialog' aria-labelledby='modal_label_"+b.id+"' aria-hidden='true' style='width: "+
b.width+"px; margin-left: -"+b.width/2+"px;overflow: hidden'>";var c=b.content?b.content:"Loading...";b.hideHeader||(a+="<div class='modal-header'><button type='button' class='close' data-dismiss='modal' aria-hidden='true'>x</button><h3 id='modal_label_"+b.id+"'>"+b.title+"</h3></div>");a+="<div class='modal-body' style='max-height: "+b.height+"px'>"+c+"</div></div>";$("body").append(a);var d="#"+b.id;$(d).on("hidden",function(){if(b.onClose)b.onClose();$(d).remove()});$(d).on("shown",function(){if(b.onShown)b.onShown()});
$(d).modal({remote:b.url,keyboard:b.keyboard,backdrop:b.backdrop})};d.hideModal=function(){$("#modal_element_id").modal("hide")};d.areYouSureOptions={};d.areYouSure=function(a){a.title||(a.title="Are you sure?");a.message||(a.message=a.title);var b={url:f+"/dialog/areYouSureFragment?message="+encodeURIComponent(a.message),title:a.title};d.areYouSureOptions.affirmativeAction=a.affirmativeAction;d.areYouSureOptions.negativeAction=a.negativeAction;d.showModal(b)};d.onAlbumSelected=null;d.selectAlbum=
function(a){var b={title:"Select an album",url:f+"/album/selectAlbumFragment"};d.onAlbumSelected=function(b){d.hideModal();a&&a(b)};d.showModal(b)};d.onTagSelected=null;d.onTagCreated=null;d.selectTag=function(a){var b={width:700,title:"Select a tag",url:f+"/tag/selectTagFragment"};d.onTagSelected=function(b){d.hideModal();a&&a(b)};d.showModal(b)};d.createNewTag=function(a,b){a={title:"Create new tag from path",url:f+"/tag/createTagFragment?parentTagId="+a};d.onTagCreated=function(a){d.hideModal();
b&&b(a)};d.showModal(a)};d.onAddMetadata=null;d.promptForMetadata=function(a){var b={title:"Add meta data item",url:f+"/dialog/addUserMetadataFragment"};d.onAddMetadata=function(b,f){d.hideModal();a&&a(b,f)};d.showModal(b)};d.bindImageTagTooltips=function(){$(".image-tags-button").each(function(){var a=$(this).closest("[imageId]").attr("imageId");a&&$(this).qtip({content:{text:function(b,c){$.ajax(f+"/image/imageTagsTooltipFragment/"+a).then(function(a){c.set("content.text",a)},function(a,b,d){c.set("content.text",
b+": "+d)})}}})})};d.htmlEscape=function(a){return String(a).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};d.htmlUnescape=function(a){return String(a).replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")};d.showSpinner=function(a){var b=$(".spinner");a?b.attr("title",a):b.attr("title","");b.css("display","block")};d.hideSpinner=function(){$(".spinner").css("display","none")};d.bindTooltips=
function(a,b){a||(a="a.fieldHelp");b||(b=300);$(a).each(function(){var a=$(this).attr("tooltipPosition");a||(a="bottomRight");var d=$(this).attr("targetPosition");d||(d="topMiddle");var e=$(this).attr("tipPosition");e||(e="bottomRight");var f=$(this).attr("width");f&&(b=f);$(this).qtip({tip:!0,position:{corner:{target:d,tooltip:a}},style:{width:b,padding:8,background:"white",color:"black",textAlign:"left",border:{width:4,radius:5,color:"#E66542"},tip:e,name:"light"}}).bind("click",function(a){a.preventDefault();
return!1})})}})(imgvwr);