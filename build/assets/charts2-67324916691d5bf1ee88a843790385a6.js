//# sourceMappingURL=charts2.js.map
var baseFacetChart={collectionsUrl:"http://no-default-collectory",biocacheServicesUrl:"http://no-default-biocache/ws",biocacheWebappUrl:"http://no-default-biocache",chartsDiv:null,chart:null,width:600,height:450,chartArea:{left:0,top:30,width:"90%",height:"70%"},is3D:!1,titleTextStyle:{color:"#555",fontName:"Arial",fontSize:15},sliceVisibilityThreshold:0,legend:{position:"right"},chartType:"pie",column1DataType:"string",datasets:1,backgroundColor:{fill:"transparent"},individualChartOptions:{state_conservation:{chartArea:{left:60,
height:"58%"},title:"By state conservation status"},occurrence_year:{chartArea:{left:60,height:"55%"},requestFacetName:"decade"},decade:{chartArea:{left:60,height:"55%"},responseFacetName:"occurrence_year"},year:{width:600},month:{width:600},institution_uid:{chartArea:{left:0,width:"100%"}},collection_uid:{chartArea:{left:0,width:"100%"}},species_group:{title:"By higher-level group",ignore:["Animals"],chartType:"column",width:450,chartArea:{left:60,height:"58%"},vAxis:{minValue:0,textPosition:"in",
gridlines:{color:"#ddd",count:4}},colors:["#108628"],reverseCategories:!0,hAxis:{slantedTextAngle:60}},state:{ignore:["Unknown1"]},type_status:{title:"By type status (as % of all type specimens)",ignore:["notatype"]},el895:{hAxis:{title:"Moisture Index"}},el882:{hAxis:{title:"mm"},chartArea:{width:"65%"}},el889:{hAxis:{title:"mm"}},el887:{hAxis:{title:"MJ/m2/day"}},el865:{hAxis:{title:"Moisture Index"}},el894:{hAxis:{title:"MJ/m2/day"}},el895Outliers:{hAxis:{title:"Moisture Index"},chartArea:{width:"65%"},
facets:["el895"],facetLabels:["Precipitation"],singleFacetName:"el895",avoidTitlePrefix:!0},el882Outliers:{hAxis:{title:"mm"},chartType:"scatter",chartArea:{width:"65%"},facets:["el882"],facetLabels:["Precipitation"],singleFacetName:"el882",avoidTitlePrefix:!0},el889Outliers:{hAxis:{title:"mm"},chartArea:{width:"65%"},facets:["el889"],facetLabels:["Precipitation"],singleFacetName:"el889",avoidTitlePrefix:!0},el887Outliers:{hAxis:{title:"MJ/m2/day"},chartArea:{width:"65%"},facets:["el887"],facetLabels:["Precipitation"],
singleFacetName:"el887",avoidTitlePrefix:!0},el865Outliers:{hAxis:{title:"Moisture Index"},chartArea:{width:"65%"},facets:["el865"],facetLabels:["Precipitation"],singleFacetName:"el865",avoidTitlePrefix:!0},el894Outliers:{hAxis:{title:"MJ/m2/day"},chartArea:{width:"65%"},facets:["el894"],facetLabels:["Precipitation"],singleFacetName:"el894",avoidTitlePrefix:!0},el895OutliersCumm:{hAxis:{title:"Moisture Index"},chartArea:{width:"65%"},facets:["el895"],facetLabels:["Precipitation"],singleFacetName:"el895",
avoidTitlePrefix:!0},el882OutliersCumm:{hAxis:{title:"mm"},chartArea:{width:"65%"},facets:["el882"],facetLabels:["Precipitation"],singleFacetName:"el882",avoidTitlePrefix:!0},el889OutliersCumm:{hAxis:{title:"mm"},chartArea:{width:"65%"},facets:["el889"],facetLabels:["Precipitation"],singleFacetName:"el889",avoidTitlePrefix:!0},el887OutliersCumm:{hAxis:{title:"MJ/m2/day"},chartArea:{width:"65%"},facets:["el887"],facetLabels:["Precipitation"],singleFacetName:"el887",avoidTitlePrefix:!0},el865OutliersCumm:{hAxis:{title:"Moisture Index"},
chartArea:{width:"65%"},facets:["el865"],facetLabels:["Precipitation"],singleFacetName:"el865",avoidTitlePrefix:!0},el894OutliersCumm:{hAxis:{title:"MJ/m2/day"},chartArea:{width:"65%"},facets:["el894"],facetLabels:["Precipitation"],singleFacetName:"el894",avoidTitlePrefix:!0},radiation:{hAxis:{title:"MJ/m2/day"},chartArea:{width:"65%"},facets:["el887","el894"],facetLabels:["seasonality (Bio23)","warmest quarter (Bio26)"]},precipitation:{hAxis:{title:"mm"},chartArea:{width:"65%"},facets:["el882","el889"],
facetLabels:["seasonality (Bio15)","driest quarter (Bio17)"]},moisture:{hAxis:{title:"Moisture Index"},chartArea:{width:"65%"},facets:["el895","el865"],facetLabels:["lowest period (Bio30)","highest quarter mean (Bio32)"]}},getChartTypeOptions:function(a){return void 0!==this.individualChartOptions[a]?this.individualChartOptions[a]:{}},chartLabels:{institution_uid:"institution",data_resource_uid:"data set",assertions:"data assertion",biogeographic_region:"biogeographic region",occurrence_year:"decade",
el895:"Moisture Index - lowest period (Bio30)",el895Outliers:"Moisture Index - lowest period (Bio30)",el895OutliersCumm:"Moisture Index - lowest period (Bio30)",el882:"Precipitation - seasonality (Bio15)",el882Outliers:"Precipitation - seasonality (Bio15) - Outliers",el882OutliersCumm:"Precipitation - seasonality (Bio15) - Outliers (Cumulative)",el889:"Precipitation - driest quarter (Bio17)",el889Outliers:"Precipitation - driest quarter (Bio17) - Outliers",el889OutliersCumm:"Precipitation - driest quarter (Bio17) - Outliers (Cumulative)",
el887:"Radiation - seasonality (Bio23)",el887Outliers:"Radiation - seasonality (Bio23) - Outliers",el887OutliersCumm:"Radiation - seasonality (Bio23) - Outliers (Cumulative)",el865:"Moisture Index - highest quarter mean (Bio32)",el865Outliers:"Moisture Index - highest quarter mean (Bio32) - Outliers",el865OutliersCumm:"Moisture Index - highest quarter mean (Bio32) - Outliers (Cumulative)",el894:"Radiation - warmest quarter (Bio26)",el894Outliers:"Radiation - warmest quarter (Bio26) - Outliers",el894OutliersCumm:"Radiation - warmest quarter (Bio26) - Outliers (Cumulative)",
radiation:"Radiation",precipitation:"Precipitation",moisture:"Moisture"},googleChartOptions:function(){var a={},b=this;$.each("width height chartArea is3D titleTextStyle sliceVisibilityThreshold legend hAxis vAxis title colors reverseCategories fontSize backgroundColor axisTitlesPosition fontName focusTarget titlePosition tooltip".split(" "),function(c,d){void 0!=b[d]&&(a[d]=b[d])});return a},name:"",chartLabel:function(){return this.chartLabels[this.name]?this.chartLabels[this.name]:this.name},title:function(){return"By "+
this.chartLabel()},transformData:function(a){return this.syncTransforms[this.name]?this.syncTransforms[this.name].apply(null,[a]):a},syncTransforms:{occurrence_year:function(a){var b,c=[];$.each(a,function(a,e){if("before"===e.label)c.splice(0,0,{label:"before "+b,count:e.count});else{var f=e.label.substr(0,4);0===a&&(b=f);c.push({label:f+"s",count:e.count})}});return c},decade:function(a){var b,c=[];$.each(a,function(a,e){if("before"===e.label)c.splice(0,0,{label:"before "+b,count:e.count});else{var f=
e.label.substr(0,4);0===a&&(b=f);c.push({label:f+"s",count:e.count})}});return c},year:function(a){var b,c=3E3,d=0,e={},f=[];$.each(a,function(a,f){b=f.label;Number(b)<c&&(c=Number(b));Number(b)>d&&(d=Number(b));e[b]=f.count});if(c>d)return[];for(y=c;y<=d;y++)f.push({label:""+y,count:e[""+y]||0});return f}},formatLabel:function(a){return this.labelFormatters[this.name]?this.labelFormatters[this.name].apply(null,[a]):a},labelFormatters:{month:function(a){return transformMonthData(a)}},transformDataAfter:function(a,
b){var c=this.asyncTransforms[this.name];c&&c.method.apply(null,[this.chart,a,b,c.param])},asyncTransforms:{collection_uid:{method:lookupEntityNameFromUids,param:"collection"},institution_uid:{method:lookupEntityNameFromUids,param:"institution"},data_resource_uid:{method:lookupEntityNameFromUids,param:"dataResource"}},setType:function(a){this.chartType=a},init:function(a,b){var c=this.name;this.title="undefined"!==b.avoidTitlePrefix&&b.avoidTitlePrefix?this.chartLabel():"By "+this.chartLabel();var d=
$.extend(!0,{},this.getChartTypeOptions(c),b,b[c]||{}),e;for(e in d)if(d.hasOwnProperty(e))if("object"!==typeof d[e]||$.isArray(d[e]))this[e]=d[e];else for(var f in d[e])d[e].hasOwnProperty(f)&&(void 0===this[e]&&(this[e]={}),this[e][f]=d[e][f]);void 0!=d.displayRecordsUrl&&(biocacheWebappUrl=d.displayRecordsUrl);this.chartsDiv=$("#"+(this.chartsDiv||"charts"));var g=this,h=this.buildDataTable(c,a,b);if(!(2>h.getNumberOfRows())){a=$("#"+c);0==a.length&&(a=$("<div id='"+c+"'></div>"),this.chartsDiv.append(a));
a.addClass("chart-"+this.chartType);switch(this.chartType){case "column":this.chart=new google.visualization.ColumnChart(a[0]);break;case "bar":this.chart=new google.visualization.BarChart(a[0]);break;case "line":this.chart=new google.visualization.LineChart(a[0]);break;case "scatter":this.chart=new google.visualization.ScatterChart(a[0]);break;default:this.chart=new google.visualization.PieChart(a[0])}this.chart.draw(h,this.googleChartOptions());this.transformDataAfter(h,$.extend(!0,{},this.googleChartOptions()));
0!=this.clickThru&&google.visualization.events.addListener(this.chart,"select",function(){var a=h.getValue(g.chart.getSelection()[0].row,0),b=c+":"+a;if("occurrence_year"==c||"decade"==c)"before"==a.match("^before")?b="occurrence_year:[*%20TO%201849-12-31T23:59:59Z]":(a=a.substr(0,4),b=parseInt(a)+9,b="occurrence_year:["+a+"-01-01T00:00:00Z%20TO%20"+b+"-12-31T23:59:59Z]");document.location=urlConcat(biocacheWebappUrl,"/occurrences/search?q=")+g.query+"&fq="+b})}},buildDataTable:function(a,b,c){this.column1DataType=
this.column1||"string";var d=this,e=b[a];"undefined"!==d.singleFacetName&&null!=d.singleFacetName&&(e=b[d.singleFacetName]);var e=this.transformData(e),e=this.formatLabel(e),f=new google.visualization.DataTable;if((a=this.getChartTypeOptions(a))&&a.facets&&"undefined"==c.outlierValues){f.addColumn(this.column1DataType,this.chartLabel());for(var g=0;g<a.facets.length;g++)f.addColumn("number",a.facetLabels?a.facetLabels[g]:this.chartLabel())}else void 0!==c.outlierValues?(f.addColumn("number",this.chartLabel()),
f.addColumn("number","records"),f.addColumn("number","outliers"),f.addColumn("number","this record (outlier)")):("number"==this.column1DataType?f.addColumn("number",this.chartLabel()):f.addColumn("string",this.chartLabel()),f.addColumn("number","records"));if(a&&a.facets&&1<a.facets.length){var e=b[a.facets[1]],h,k;$.each(b[a.facets[0]],function(a,b){f.addRow([parseFloat(b.label),b.count,null])});$.each(e,function(a,b){h=parseFloat(b.label);k=f.getFilteredRows([{column:1,value:h}]);0<k.length?f.setCell(k[0],
3,b.count):f.addRow([parseFloat(b.label),null,b.count])})}else void 0!==c.outlierValues?$.each(e,function(a,b){if("undefined"!==d.ignore||-1==$.inArray(b.label,d.ignore))detectCamelCase(b.label)?f.addRow([{v:b.label,f:capitalise(expandCamelCase(b.label))},b.count,null,null]):"number"===d.column1DataType?void 0!==c.highlightedValue&&b.label==c.highlightedValue?f.addRow([parseFloat(b.label),null,null,b.count]):0<=$.inArray(parseFloat(b.label),c.outlierValues)?f.addRow([parseFloat(b.label),null,b.count,
null]):f.addRow([parseFloat(b.label),b.count,null,null]):f.addRow([parseFloat(b.label),b.count,null,null])}):$.each(e,function(a,b){var c;if(void 0==d.ignore||-1==$.inArray(b.label,d.ignore))a=b.label,c=b.formattedLabel,b=b.count,detectCamelCase(a)&&(c=capitalise(expandCamelCase(a))),"number"===d.column1DataType&&(a=parseFloat(a)),a=void 0!==c?{v:a,f:c}:a,f.addRow([a,b])});return f},newChart:function(a){"function"!==typeof Object.create&&(Object.create=function(a){var b=function(){};b.prototype=a;
return new b});var b=Object.create(this),c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}},facetChartTypes={pie:function(){return baseFacetChart.newChart({chartType:"pie"})},bar:function(){var a=baseFacetChart.chartArea;a.left=170;return baseFacetChart.newChart({chartType:"bar",chartArea:a})},column:function(){var a=baseFacetChart.chartArea;a.left=60;a.height="58%";return baseFacetChart.newChart({chartType:"column",width:450,chartArea:a,hAxis:{slantedText:!0},legend:"none"})},scatter:function(){var a=
baseFacetChart.chartArea;a.left=60;a.height="65%";return baseFacetChart.newChart({chartType:"scatter",vAxis:{title:"count"},chartArea:a,column1:"number"})}},defaultChartTypes={state:"pie",institution:"pie",data_resource_uid:"pie",type_status:"pie",species_group:"pie",assertions:"bar",occurrence_year:"column",decade:"column",year:"column",month:"column",biogeographic_region:"pie",state_conservation:"column",el895:"scatter",el882:"scatter",el882OutliersCumm:"scatter",el882Outliers:"scatter",el887:"scatter",
el887Outliers:"scatter",el887OutliersCumm:"scatter",el889:"scatter",el889Outliers:"scatter",el889OutliersCumm:"scatter",el865:"scatter",el865Outliers:"scatter",el865OutliersCumm:"scatter",el894:"scatter",el894Outliers:"scatter",el894OutliersCumm:"scatter",radiation:"scatter",precipitation:"scatter",moisture:"scatter"},facetChartGroup={createChart:function(a,b,c){var d=facetChartTypes[b[a]&&b[a].chartType?b[a].chartType:defaultChartTypes[a]||"pie"]();d.name=a;d.init(c,b);return d},buildFacetsFromChartName:function(a){var b=
[a];(a=baseFacetChart.individualChartOptions[a])&&a.facets&&(b=a.facets);return"&facets="+b.join("&facets=")},loadAndDrawFacetCharts:function(a){var b=void 0==a.biocacheServicesUrl?baseFacetChart.biocacheServicesUrl:a.biocacheServicesUrl,c="",d=$("#"+(a.chartsDiv?a.chartsDiv:baseFacetChart.chartsDiv)),e=this;$.each(a.charts,function(a,b){c+=e.buildFacetsFromChartName(b)});d.append($("<span>Loading charts...</span>"));$.ajax({url:urlConcat(b,"/occurrences/search.json?pageSize=0&flimit=200&q=")+a.query+
c+"&fsort=index",dataType:"jsonp",error:function(){cleanUp()},success:function(b){d.find("span").remove();e.drawFacetCharts(b,a)}})},drawFacetCharts:function(a,b){if(0!=a.length&&void 0!=a.totalRecords&&0!=a.totalRecords){b.totalRecordsSelector&&$(b.totalRecordsSelector).html(addCommas(a.totalRecords));if(void 0!==b.cumulative&&b.cumulative)for(var c=0,d=0;d<a.facetResults[0].fieldResult.length;d++)c+=a.facetResults[0].fieldResult[d].count,a.facetResults[0].fieldResult[d].count=c;var e={};$.each(a.facetResults,
function(a,b){e[b.fieldName]=b.fieldResult});$("#"+(b.targetDivId?b.targetDivId:"charts"));var f=this;$.each(b.charts,function(a,c){f.createChart(c,b,e)})}}},loadAndDrawFacetCharts=function(a){var b=void 0==a.biocacheServicesUrl?baseFacetChart.biocacheServicesUrl:a.biocacheServicesUrl,c=a.charts.join("&facets="),d=$("#"+(a.chartsDiv?a.chartsDiv:baseFacetChart.chartsDiv));d.append($("<span>Loading charts...</span>"));$.ajax({url:urlConcat(b,"/occurrences/search.json?pageSize=0&q=")+a.query+"&facets="+
c+"&fsort=index",dataType:"jsonp",error:function(){cleanUp()},success:function(b){d.find("span").remove();drawFacetCharts(b,a)}})},collectionsUrl="https://collections.ala.org.au",biocacheServicesUrl="https://biocache.ala.org.au/ws",biocacheWebappUrl="https://biocache.ala.org.au",taxonomyPieChartOptions={width:480,height:350,chartArea:{left:0,top:30,width:"100%",height:"70%"},is3D:!1,titleTextStyle:{color:"#555",fontName:"Arial",fontSize:15},sliceVisibilityThreshold:0,legend:"right"},genericChartOptions=
{width:480,height:350,chartArea:{left:0,top:30,width:"100%",height:"70%"},is3D:!1,titleTextStyle:{color:"#555",fontName:"Arial",fontSize:15},sliceVisibilityThreshold:0,legend:"right",chartType:"pie"},individualChartOptions={state_conservation:{chartType:"column",width:450,chartArea:{left:60,height:"58%"},title:"By state conservation status",hAxis:{slantedText:!0}},occurrence_year:{chartType:"column",width:450,chartArea:{left:60,height:"65%"},hAxis:{slantedText:!0}},species_group:{title:"By higher-level group",
ignore:["Animals"]},state:{ignore:["Unknown1"]},type_status:{title:"By type status (as % of all type specimens)",ignore:["notatype"]},assertions:{chartType:"bar",chartArea:{left:170}}},chartLabels={institution_uid:"institution",data_resource_uid:"data set",assertions:"data assertion",biogeographic_region:"biogeographic region",occurrence_year:"decade"},asyncTransforms={},syncTransforms={collection_uid:{method:"transformFqData"},institution_uid:{method:"transformFqData"},data_resource_uid:{method:"transformFqData"},
occurrence_year:{method:"transformDecadeData"},month:{method:"transformMonthData"}};
function loadFacetCharts(a){void 0!=a.collectionsUrl&&(collectionsUrl=a.collectionsUrl);void 0!=a.biocacheServicesUrl&&(biocacheServicesUrl=a.biocacheServicesUrl);void 0!=a.displayRecordsUrl&&(biocacheWebappUrl=a.displayRecordsUrl);var b=$("#"+(a.targetDivId?a.targetDivId:"charts"));b.append($("<span>Loading charts...</span>"));console.log("loadFacetCharts");console.log(a);var c=a.query?a.query:buildQueryString(a.instanceUid);$.ajax({url:urlConcat(biocacheServicesUrl,"/occurrences/search.json?pageSize=0&q=")+
c+"&fsort=index",dataType:"jsonp",error:function(){cleanUp()},success:function(c){b.find("span").remove();drawFacetCharts(c,a)}})}function cleanUp(a){$("img.loading").remove();if(void 0!=a&&a.error)window[a.error]()}
function drawFacetCharts(a,b){if(0!=a.length&&void 0!=a.totalRecords&&0!=a.totalRecords){b.totalRecordsSelector&&$(b.totalRecordsSelector).html(addCommas(a.totalRecords));var c={};$.each(a.facetResults,function(a,b){c[b.fieldName]=b.fieldResult});var d=$("#"+(b.targetDivId?b.targetDivId:"charts")),e=b.query?b.query:buildQueryString(b.instanceUid);$.each(b.charts,function(a,g){void 0!=c[g]&&buildGenericFacetChart(g,c[g],e,d,b)})}}
function buildGenericFacetChart(a,b,c,d,e){var f=chartLabels[a]?chartLabels[a]:a,g=$.extend({},genericChartOptions);g.title="By "+f;var g=$.extend(!0,{},g,individualChartOptions[a]?individualChartOptions[a]:{},e[a]),h=b;syncTransforms[a]&&(h=window[syncTransforms[a].method](b));var k=new google.visualization.DataTable;k.addColumn("string",f);k.addColumn("number","records");$.each(h,function(a,b){if(void 0==g||void 0==g.ignore||-1==$.inArray(b.label,g.ignore))detectCamelCase(b.label)?k.addRow([{v:b.label,
f:capitalise(expandCamelCase(b.label))},b.count]):b.formattedLabel?k.addRow([{v:b.label,f:b.formattedLabel},b.count]):k.addRow([b.label,b.count])});if(!(2>k.getNumberOfRows())){b=$("#"+a);0==b.length&&(b=$("<div id='"+a+"'></div>"),d.append(b));b.addClass("chart-"+g.chartType);console.log("Loading chart");console.log(g);var l;switch(g.chartType){case "column":l=new google.visualization.ColumnChart(document.getElementById(a));break;case "bar":l=new google.visualization.BarChart(document.getElementById(a));
break;case "line":l=new google.visualization.LineChart(document.getElementById(a));break;case "scatter":l=new google.visualization.ScatterChart(document.getElementById(a));break;default:l=new google.visualization.PieChart(document.getElementById(a))}l.draw(k,g);if(asyncTransforms[a])window[asyncTransforms[a].method](l,k,g,asyncTransforms[a].param);0!=e.clickThru&&google.visualization.events.addListener(l,"select",function(){var b=k.getValue(l.getSelection()[0].row,0),d;d=-1!=b.indexOf(a)?b:a+":"+
b;"occurrence_year"==a&&("before"==b.match("^before")?d="occurrence_year:[*%20TO%201850-01-01T12:00:00Z]":(b=b.substr(0,4),d=parseInt(b)+10,d="occurrence_year:["+b+"-01-01T12:00:00Z%20TO%20"+d+"-01-01T12:00:00Z]"));document.location=urlConcat(biocacheWebappUrl,"/occurrences/search?q=")+c+"&fq="+d})}}
function transformDecadeData(a){var b,c=[];$.each(a,function(a,e){if("before"==e.label)c.splice(0,0,{label:"before "+b,count:e.count});else{var f=e.label.substr(0,4);0==a&&(b=f);c.push({label:f+"s",count:e.count})}});return c}function transformMonthData(a){var b="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),c;$.each(a,function(a,e){c=parseInt(e.label,10);e.formattedLabel=b[c-1]});return a}
function transformFqData(a){$.each(a,function(a,c){c.fq&&(c.formattedLabel=c.label,c.label=c.fq)});return a}function detectCamelCase(a){return/[a-z][A-Z]/.test(a)}function expandCamelCase(a){return a.replace(/([a-z])([A-Z])/g,function(a,c,d){return c+" "+d.toLowerCase()})}function capitalise(a){return a.replace(/^./,function(a){return a.toUpperCase()})}
function lookupEntityName(a,b,c,d){d=[];for(var e=0;j=b.getNumberOfRows(),e<j;e++)d.push(b.getValue(e,0));$.jsonp({url:collectionsUrl+"/ws/resolveNames/"+d.join(",")+"?callback=?",cache:!0,success:function(d){for(var e=0;j+b.getNumberOfRows(),e<j;e++){var h=b.getValue(e,0);b.setCell(e,0,h,d[h])}a.draw(b,c)},error:function(a,b){alert(b)}})}
function lookupEntityNameFromUids(a,b,c){for(var d=[],e=0;j=b.getNumberOfRows(),e<j;e++)d.push(b.getValue(e,0));$.jsonp({url:collectionsUrl+"/ws/resolveNames/"+d.join(",")+"?callback=?",cache:!0,success:function(d){for(var e=0;j+b.getNumberOfRows(),e<j;e++){var h=b.getValue(e,0);b.setCell(e,0,h,d[h])}a.draw(b,c)},error:function(a,b){alert(b)}})}
var taxonomyChart={baseQuery:"",query:"",rank:void 0,name:void 0,threshold:void 0,chartOptions:{},historyState:[],hasState:function(){return 0<this.historyState.length},pushState:function(){this.historyState.push({rank:this.rank,name:this.name})},popState:function(){return this.hasState()?this.historyState.pop():{}},cleanUp:function(){$("img.loading").remove();if(void 0!=this.chartOptions&&this.chartOptions.error)window[this.chartOptions.error]()},load:function(a){var b=this;a&&(this.chartOptions=
a,void 0!=a.collectionsUrl&&(collectionsUrl=a.collectionsUrl),void 0!=a.biocacheServicesUrl&&(biocacheServicesUrl=a.biocacheServicesUrl),void 0!=a.displayRecordsUrl&&(biocacheWebappUrl=a.displayRecordsUrl),this.baseQuery=a.query?a.query:buildQueryString(a.instanceUid),this.query=this.baseQuery+(a.subquery?a.subquery:""),this.rank=a.rank,this.name=a.name,this.threshold=a.threshold);a=urlConcat(biocacheServicesUrl,"/breakdown.json?q=")+this.query;a=this.rank?a+("&rank="+this.rank+(this.name?"&name="+
this.name:"")):a+("&max="+(this.threshold?this.threshold:"55"));$.ajax({url:a,dataType:"jsonp",timeout:3E4,complete:function(a,d){"timeout"==d&&alert("Sorry - the request was taking too long so it has been cancelled.");"error"==d&&alert("Sorry - the chart cannot be redrawn due to an error.");"success"!=d&&b.cleanUp()},success:function(a){void 0!=a&&0<a.taxa.length&&b.draw(a)}})},draw:function(a){var b=this,c=new google.visualization.DataTable;c.addColumn("string",chartLabels[name]?chartLabels[name]:
name);c.addColumn("number","records");$.each(a.taxa,function(a,b){c.addRow([b.label,b.count])});var d=$.extend({},taxonomyPieChartOptions),d=$.extend(!0,d,this.chartOptions);d.title=d.name?d.name+" records by "+a.rank:"By "+a.rank;var e=$("#taxa");0==e.length&&(e=$('<div id="taxa"></div>'),e.css("margin-bottom","-50px"),$("div#"+(this.chartOptions.targetDivId?this.chartOptions.targetDivId:"charts")).prepend(e));var f=$("#taxaChart");0==f.length&&(f=$("<div id='taxaChart' class='chart-pie'></div>"),
e.append(f));var g=new google.visualization.PieChart(document.getElementById("taxaChart"));if(this.chartOptions.notifyChange)window[this.chartOptions.notifyChange](this.rank,this.name);g.draw(c,d);var h=$("#backLink");0==h.length&&(h=$('<div class="link" id="backLink">&laquo; Previous rank</div>').appendTo(e),h.css("position","relative").css("top","-75px"),h.click(function(){if(h.hasClass("link")){f.append($('<img class="loading" style="position:absolute;left:130px;top:220px;z-index:2000" alt="loading..." src="'+
collectionsUrl+'/images/ala/ajax-loader.gif"/>'));var a=b.popState();taxonomyChart.rank=a.rank;taxonomyChart.name=a.name;b.load()}}));this.hasState()?h.html("&laquo; Previous rank").addClass("link"):h.html("Click a slice to drill into the next taxonomic level.").removeClass("link");d=$("#recordsLink");0==d.length&&(d=$('<div class="link under" id="recordsLink">View records</div>').appendTo(e),d.css("position","relative").css("top","-75px"),d.click(function(){b.showRecords()}));this.hasState()?d.html("View records for "+
this.rank+" "+this.name):d.html("View all records");var k=void 0==this.chartOptions.clickThru?!0:this.chartOptions.clickThru,l=void 0==this.chartOptions.drillDown?!0:this.chartOptions.drillDown;(k||l)&&google.visualization.events.addListener(g,"select",function(){var d=c.getValue(g.getSelection()[0].row,0);l&&"species"!=a.rank?(f.append($('<img class="loading" style="position:absolute;left:130px;top:220px;z-index:2000" alt="loading..." src="'+collectionsUrl+'/images/ala/ajax-loader.gif"/>')),b.pushState(),
b.rank=a.rank,b.name=d,b.load()):k&&(document.location=urlConcat(biocacheWebappUrl,"/occurrences/search?q=")+query+"&fq="+a.rank+":"+d)})},showRecords:function(){var a="";void 0!=this.rank&&void 0!=this.name&&(a="&fq="+this.rank+":"+this.name);document.location=urlConcat(biocacheWebappUrl,"/occurrences/search?q=")+this.query+a},reset:function(){if(this.hasState()){var a=this.historyState[0];this.rank=a.rank;this.name=a.name}this.query=this.baseQuery;this.load()},updateQuery:function(a){this.query=
a;this.load()}};
function initTaxonTree(a){var b=a.query?a.query:buildQueryString(a.instanceUid),c=$("#"+(a.targetDivId?a.targetDivId:"tree")),d=a.title||"Explore records by taxonomy";""!==a.title&&c.append($("<h4>"+d+"</h4>"));var e=$('<div id="treeContainer"></div>').appendTo(c);e.resizable({maxHeight:900,minHeight:100,maxWidth:900,minWidth:500});var f=$('<div id="taxaTree"></div>').appendTo(e);f.bind("after_open.jstree",function(a,b){a=$.jstree._reference(b.rslt.obj)._get_children(b.rslt.obj);1==a.length&&f.jstree("open_node",
a[0]);a=f[0].scrollHeight;a>f.height()&&(a=Math.min(a,700),e.animate({height:a}))}).bind("select_node.jstree",function(a,b){f.jstree("show_contextmenu",b.rslt.obj)}).bind("loaded.jstree",function(a,b){f.jstree("open_node","#top")}).jstree({json_data:{data:{data:"Kingdoms",state:"closed",attr:{rank:"kingdoms",id:"top"}},ajax:{url:function(a){var c=$(a).attr("rank"),d=urlConcat(biocacheServicesUrl,"/breakdown.json?q=")+b+"&rank=";return d="kingdoms"==c?d+"kingdom":d+(c+"&name="+$(a).attr("id"))},dataType:"jsonp",
success:function(a){var b=[],c=a.rank;$.each(a.taxa,function(a,d){a=d.label+" - "+d.count;"species"==c?b.push({data:a,attr:{rank:c,id:d.label}}):b.push({data:a,state:"closed",attr:{rank:c,id:d.label}})});return b},error:function(a,b){}}},core:{animation:200,open_parents:!0},themes:{theme:a.theme||"default",icons:a.icons||!1,url:a.serverUrl+"/js/themes/"+(a.theme||"default")+"/style.css"},checkbox:{override_ui:!0},contextmenu:{select_node:!1,show_at_node:!1,items:{records:{label:"Show records",action:function(a){showRecords(a,
b)}},bie:{label:"Show information",action:function(a){showBie(a)}},create:!1,rename:!1,remove:!1,ccp:!1}},plugins:["json_data","themes","ui","contextmenu"]})}function showRecords(a,b){var c=a.attr("rank");"kingdoms"!=c&&(a=a.attr("id"),b=urlConcat(biocacheWebappUrl,"/occurrences/search?q=")+b+"&fq="+c+":"+a,document.location.href=b)}function showBie(a){var b=a.attr("rank");"kingdoms"!=b&&(a="https://bie.ala.org.au/species/"+a.attr("id"),"species"!=b&&(a+="_("+b+")"),document.location.href=a)}
function buildQueryString(a){a="string"==typeof a?a.split(","):a;var b="";$.each(a,function(a,d){b+=solrFieldNameForUid(d)+":"+d+" OR "});return b.substring(0,b.length-4)}function solrFieldNameForUid(a){switch(a.substring(0,2)){case "co":return"collection_uid";case "in":return"institution_uid";case "dp":return"data_provider_uid";case "dr":return"data_resource_uid";case "dh":return"data_hub_uid";default:return""}}
function wsEntityForBreakdown(a){switch(a.substr(0,2)){case "co":return"collections";case "in":return"institutions";case "dr":return"dataResources";case "dp":return"dataProviders";case "dh":return"dataHubs";default:return""}}function urlConcat(a,b){a=a.replace(/\/$/,"");b=b.replace(/^\//,"");return a+"/"+b}function addCommas(a){x=(a+"").split(".");x1=x[0];x2=1<x.length?"."+x[1]:"";for(a=/(\d+)(\d{3})/;a.test(x1);)x1=x1.replace(a,"$1,$2");return x1+x2};